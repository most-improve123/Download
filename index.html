<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Download Certificate - WeSpark</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.4.4/build/qrcode.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8f9fa;
            color: #333;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .download-container {
            text-align: center;
            background: white;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            max-width: 500px;
            width: 90%;
        }

        .logo {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 1.5rem;
        }

        .logo i {
            color: #FCD307;
            font-size: 2rem;
            margin-right: 0.5rem;
        }

        .logo span {
            font-size: 1.5rem;
            font-weight: 700;
            color: #333;
        }

        .download-container h2 {
            font-size: 1.5rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 0.5rem;
        }

        .download-container p {
            color: #666;
            margin-bottom: 2rem;
            font-size: 0.9rem;
        }

        .spinner {
            width: 3rem;
            height: 3rem;
            border: 3px solid #e0e0e0;
            border-top: 3px solid #FCD307;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 2rem auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        #success-message {
            display: none;
            color: #28a745;
            font-weight: bold;
            margin-top: 1rem;
        }

        #countdown {
            font-size: 0.9rem;
            color: #666;
            margin-top: 1rem;
            font-weight: 500;
        }
    </style>
</head>
<body>
    <div class="download-container">
        <div class="logo">
            <i class="fas fa-graduation-cap"></i>
            <span>WeSpark</span>
        </div>
        <h2>Preparing Your Certificate</h2>
        <p>Your certificate will download automatically in a moment.</p>
        <div class="spinner"></div>
        <p id="success-message">
            <i class="fas fa-check-circle"></i> Certificate downloaded successfully!
        </p>
        <p id="countdown">Redirecting in 10 seconds...</p>
    </div>

    <script>
        // Configuración de Firebase para Certificates
        const firebaseConfigCertificates = {
            apiKey: "AIzaSyCmTISieA5tp7AKtXM0Vuf5afFuCZXv33k",
            authDomain: "wses-a18fa.firebaseapp.com",
            projectId: "wses-a18fa",
            storageBucket: "wses-a18fa.appspot.com",
            messagingSenderId: "147530546947",
            appId: "1:147530546947:web:236f6e900decf4b0bab336"
        };

        // Inicializar Firebase para Certificates
        const appCertificates = firebase.initializeApp(firebaseConfigCertificates, "appCertificates");
        const dbCertificates = appCertificates.firestore();

        // Obtener parámetros de la URL
        const urlParams = new URLSearchParams(window.location.search);
        const certificateId = urlParams.get('certificateId');
        const userName = decodeURIComponent(urlParams.get('userName') || '');
        const courseTitle = decodeURIComponent(urlParams.get('courseTitle') || '');
        const completionDate = urlParams.get('completionDate') || new Date().toISOString().split('T')[0];
        const hashHex = urlParams.get('hashHex') || '';

        // Función para generar un hash
        async function generateHash(input) {
            const encoder = new TextEncoder();
            const data = encoder.encode(input);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        // Función para guardar el certificado en Firestore
        async function saveCertificateToFirestore(id, nombre, curso, fecha, hashHex) {
            try {
                await dbCertificates.collection('certificates').add({
                    id: id,
                    nombre: nombre,
                    curso: curso,
                    fecha: fecha,
                    hash: hashHex,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                console.log("Certificado guardado en Firestore");
            } catch (error) {
                console.error("Error al guardar en Firestore:", error);
            }
        }

        // Función para generar el enlace del código QR
        function generateQRCodeLink(id) {
            return 'https://static.wixstatic.com/media/a687f1_d41ce5e63188472fbf07f5d14db3c63e~mv2.png';
        }

        // Función para generar el PDF (exactamente igual que en tu proyecto)
        async function generarPDFIndividual(nombre, curso, fecha, id, hashHex) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ orientation: 'landscape', unit: 'pt', format: 'A4' });

            const loadAndRegisterFont = async (url, fontName, fontStyle) => {
                const response = await fetch(url);
                const fontData = await response.arrayBuffer();
                const base64Font = btoa(
                    new Uint8Array(fontData).reduce(
                        (data, byte) => data + String.fromCharCode(byte),
                        ''
                    )
                );
                doc.addFileToVFS(`${fontName}.ttf`, base64Font);
                doc.addFont(`${fontName}.ttf`, fontName, fontStyle);
            };

            const loadImage = (src) => {
                return new Promise((resolve, reject) => {
                    const img = new Image();
                    img.crossOrigin = "Anonymous";
                    img.onload = () => resolve(img);
                    img.onerror = reject;
                    img.src = src;
                });
            };

            try {
                // Cargar fuentes Roboto
                await loadAndRegisterFont(
                    'https://cdnjs.cloudflare.com/ajax/libs/ink/3.1.10/fonts/Roboto/roboto-regular-webfont.ttf',
                    'Roboto',
                    'normal'
                );
                await loadAndRegisterFont(
                    'https://cdnjs.cloudflare.com/ajax/libs/ink/3.1.10/fonts/Roboto/roboto-bold-webfont.ttf',
                    'Roboto',
                    'bold'
                );

                // Cargar imágenes
                const fondoURL = 'https://static.wixstatic.com/media/a687f1_6daa751a4aac4a418038ae37f20db004~mv2.jpg';
                const qrUrl = generateQRCodeLink(id);
                const fondo = await loadImage(fondoURL);
                const qrImage = await loadImage(qrUrl);

                // Generar el PDF
                doc.addImage(fondo, 'JPEG', 0, 0, 850, 595);
                doc.setFont('Roboto', 'bold');
                doc.setFontSize(37);
                doc.setTextColor(0, 0, 0);
                doc.text(curso, 425, 130, { align: 'center' });

                doc.setFontSize(35);
                doc.setTextColor(255, 255, 255);
                doc.text(nombre, 425, 190, { align: 'center' });

                doc.setFont('Roboto', 'normal');
                doc.setFontSize(14);
                doc.setTextColor(0, 0, 0);
                const text = "WeSpark certifies that you have completed our future-ready learning experience designed to build practical";
                doc.text(doc.splitTextToSize(text, 700), 80, 250);
                const text1 = "skills for real-world impact. This certificate celebrates your participation in our interactive, innovation-focused";
                doc.text(doc.splitTextToSize(text1, 700), 80, 270);
                doc.text("training. Now go out there and release your inner genius!", 260, 290);

                // Fecha
                const fechaActual = new Date(fecha);
                const dia = String(fechaActual.getDate()).padStart(2, '0');
                const mes = String(fechaActual.getMonth() + 1).padStart(2, '0');
                const anio = fechaActual.getFullYear();
                const fechaFormateada = `${dia}.${mes}.${anio}`;

                doc.setFont('Roboto', 'bold');
                doc.setFontSize(13);
                doc.setTextColor(255, 255, 255);
                doc.text(`San Salvador, ${fechaFormateada}`, 340, 320);

                doc.setFont('Roboto', 'normal');
                doc.setFontSize(10);
                doc.setTextColor(0, 0, 0);
                doc.text(`ID: ${id}`, 4, 15);
                doc.text(`Hash: ${hashHex}`, 263, 585);

                doc.addImage(qrImage, 'PNG', 124, 460, 100, 100);

                return doc.output('blob');
            } catch (error) {
                console.error("Error al generar PDF:", error);
                throw error;
            }
        }

        // Función para descargar el PDF
        async function downloadPDF() {
            try {
                // Generar el PDF
                const pdfBlob = await generarPDFIndividual(userName, courseTitle, completionDate, certificateId, hashHex);

                // Guardar el certificado en Firestore
                await saveCertificateToFirestore(certificateId, userName, courseTitle, completionDate, hashHex);

                // Descargar el PDF automáticamente
                const pdfUrl = URL.createObjectURL(pdfBlob);
                const a = document.createElement('a');
                a.href = pdfUrl;
                a.download = `certificate_${certificateId}.pdf`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);

                // Mostrar mensaje de éxito
                document.getElementById('success-message').style.display = 'block';
                document.querySelector('.spinner').style.display = 'none';

                // Contador de redirección
                let seconds = 10;
                const countdownElement = document.getElementById('countdown');
                const countdown = setInterval(() => {
                    seconds--;
                    countdownElement.textContent = `Redirecting in ${seconds} seconds...`;
                    if (seconds <= 0) {
                        clearInterval(countdown);
                        window.location.href = 'https://tudominio.com/dashboard'; // Cambia por tu URL de Wix
                    }
                }, 1000);
            } catch (error) {
                console.error("Error:", error);
                alert("Failed to generate the certificate. Please try again.");
            }
        }

        // Ejecutar al cargar la página
        window.onload = downloadPDF;
    </script>
</body>
</html>
